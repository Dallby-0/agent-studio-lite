<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.agentworkflow.mapper.StateWorkflowMapper">

    <!-- 工作流定义相关SQL -->
    <select id="getAllWorkflows" resultType="com.agentworkflow.entity.StateWorkflowDefinition">
        SELECT * FROM state_workflow_definition WHERE is_deleted = 0
    </select>
    
    <select id="getWorkflowsByCreatedBy" resultType="com.agentworkflow.entity.StateWorkflowDefinition">
        SELECT * FROM state_workflow_definition WHERE created_by = #{createdBy} AND is_deleted = 0
    </select>

    <select id="getWorkflowById" resultType="com.agentworkflow.entity.StateWorkflowDefinition">
        SELECT * FROM state_workflow_definition WHERE id = #{id} AND is_deleted = 0
    </select>
    
    <select id="getWorkflowByIdAndCreatedBy" resultType="com.agentworkflow.entity.StateWorkflowDefinition">
        SELECT * FROM state_workflow_definition WHERE id = #{id} AND created_by = #{createdBy} AND is_deleted = 0
    </select>

    <insert id="insertWorkflow" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO state_workflow_definition (name, description, version, status, created_by, json_definition, created_at, updated_at, is_deleted)
        VALUES (#{name}, #{description}, #{version}, #{status}, #{createdBy}, #{jsonDefinition}, #{createdAt}, #{updatedAt}, #{isDeleted})
    </insert>

    <update id="updateWorkflow">
        UPDATE state_workflow_definition
        SET name = #{name}, description = #{description}, version = #{version},
            status = #{status}, json_definition = #{jsonDefinition}, updated_at = #{updatedAt}
        WHERE id = #{id}
    </update>

    <delete id="deleteWorkflow">
        UPDATE state_workflow_definition SET is_deleted = 1 WHERE id = #{id}
    </delete>

    <!-- 节点相关SQL -->
    <select id="getNodesByWorkflowId" resultType="com.agentworkflow.entity.StateNode">
        SELECT * FROM state_node WHERE workflow_id = #{workflowId}
    </select>

    <insert id="insertNode" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO state_node (workflow_id, node_key, name, type, config_json, position_x, position_y, created_at, updated_at)
        VALUES (#{workflowId}, #{nodeKey}, #{name}, #{type}, #{configJson}, #{positionX}, #{positionY}, #{createdAt}, #{updatedAt})
    </insert>

    <update id="updateNode">
        UPDATE state_node
        SET name = #{name}, type = #{type}, config_json = #{configJson},
            position_x = #{positionX}, position_y = #{positionY}, updated_at = #{updatedAt}
        WHERE id = #{id}
    </update>

    <delete id="deleteNodesByWorkflowId">
        DELETE FROM state_node WHERE workflow_id = #{workflowId}
    </delete>

    <!-- 转换相关SQL -->
    <select id="getTransitionsByWorkflowId" resultType="com.agentworkflow.entity.StateTransition">
        SELECT * FROM state_transition WHERE workflow_id = #{workflowId}
    </select>

    <insert id="insertTransition" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO state_transition (workflow_id, from_node_key, to_node_key, condition_expression, variable_mappings, created_at, updated_at)
        VALUES (#{workflowId}, #{fromNodeKey}, #{toNodeKey}, #{conditionExpression}, #{variableMappings}, #{createdAt}, #{updatedAt})
    </insert>

    <update id="updateTransition">
        UPDATE state_transition
        SET to_node_key = #{toNodeKey}, condition_expression = #{conditionExpression},
            variable_mappings = #{variableMappings}, updated_at = #{updatedAt}
        WHERE id = #{id}
    </update>

    <delete id="deleteTransitionsByWorkflowId">
        DELETE FROM state_transition WHERE workflow_id = #{workflowId}
    </delete>

    <!-- 全局变量相关SQL -->
    <select id="getGlobalVariablesByWorkflowId" resultType="com.agentworkflow.entity.GlobalVariable">
        SELECT * FROM state_global_variable WHERE workflow_id = #{workflowId}
    </select>

    <insert id="insertGlobalVariable" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO state_global_variable (workflow_id, name, type, initial_value, created_at, updated_at)
        VALUES (#{workflowId}, #{name}, #{type}, #{initialValue}, #{createdAt}, #{updatedAt})
    </insert>

    <update id="updateGlobalVariable">
        UPDATE state_global_variable
        SET type = #{type}, initial_value = #{initialValue}, updated_at = #{updatedAt}
        WHERE id = #{id}
    </update>

    <delete id="deleteGlobalVariablesByWorkflowId">
        DELETE FROM state_global_variable WHERE workflow_id = #{workflowId}
    </delete>

    <!-- 实例相关SQL -->
    <select id="getAllInstances" resultType="com.agentworkflow.entity.StateWorkflowInstance">
        SELECT * FROM state_workflow_instance ORDER BY created_at DESC
    </select>

    <select id="getInstancesByWorkflowId" resultType="com.agentworkflow.entity.StateWorkflowInstance">
        SELECT * FROM state_workflow_instance WHERE workflow_id = #{workflowId} ORDER BY created_at DESC
    </select>

    <select id="getInstanceById" resultType="com.agentworkflow.entity.StateWorkflowInstance">
        SELECT * FROM state_workflow_instance WHERE id = #{id}
    </select>

    <insert id="insertInstance" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO state_workflow_instance (workflow_id, name, status, input_params, output_params, current_node_key, global_variables, started_at, finished_at, created_at, updated_at)
        VALUES (#{workflowId}, #{name}, #{status}, #{inputParams}, #{outputParams}, #{currentNodeKey}, #{globalVariables}, #{startedAt}, #{finishedAt}, #{createdAt}, #{updatedAt})
    </insert>

    <update id="updateInstance">
        UPDATE state_workflow_instance
        SET status = #{status}, output_params = #{outputParams}, current_node_key = #{currentNodeKey},
            global_variables = #{globalVariables}, started_at = #{startedAt}, finished_at = #{finishedAt}, updated_at = #{updatedAt}
        WHERE id = #{id}
    </update>

    <delete id="deleteInstance">
        DELETE FROM state_workflow_instance WHERE id = #{id}
    </delete>

    <!-- 执行日志相关SQL -->
    <select id="getExecutionLogsByInstanceId" resultType="com.agentworkflow.entity.StateExecutionLog">
        SELECT * FROM state_execution_log WHERE instance_id = #{instanceId} ORDER BY created_at DESC
    </select>

    <insert id="insertExecutionLog" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO state_execution_log (instance_id, node_key, node_type, execution_time, status, input_data, output_data, error_message, created_at)
        VALUES (#{instanceId}, #{nodeKey}, #{nodeType}, #{executionTime}, #{status}, #{inputData}, #{outputData}, #{errorMessage}, #{createdAt})
    </insert>

    <delete id="deleteExecutionLogsByInstanceId">
        DELETE FROM state_execution_log WHERE instance_id = #{instanceId}
    </delete>

</mapper>
