import{r as c,h as Te,G as to,H as lo,e as K,c as y,o as v,b as u,d as t,w as s,f as Y,F as L,j as se,t as A,q as U,I as me,m as T,s as Ee,k as ie,z as Ae,J as no,x as ao,E as P,a as so,K as io,i as Re,L as uo,M as ro,u as co,B as po}from"./index-g6aQcVIG.js";import{L as fo}from"./Layout-kDhWiEU5.js";import{_ as Xe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{u as vo}from"./userStore-DdKhfmJw.js";import{a as mo,r as go,b as yo,c as ke,u as _o,e as wo}from"./workflow-Dm20tcuL.js";const bo={class:"workflow-designer"},ko={class:"designer-toolbar"},xo={class:"workflow-name-input"},Po={class:"toolbar-right"},Vo={class:"designer-container"},ho={class:"node-palette"},No={class:"node-list"},Ko=["onDragstart"],$o={class:"node-icon"},Io={class:"node-label"},Co=["d","onMousedown","onClick"],Mo=["cx","cy","onClick"],Do=["d"],Eo=["onMousedown","onClick"],Oo={class:"port-group port-group-input"},Uo=["data-node-key","data-port-index","onMousedown","onClick"],Yo={class:"node-content"},So={class:"node-header"},Bo={class:"node-type-icon"},zo={class:"node-name"},Ao={class:"node-type"},Ro={class:"port-group port-group-output"},To=["data-node-key","data-port-index","onMousedown","onClick"],Xo=["onClick"],jo=["onClick"],Wo={class:"properties-panel"},Lo={key:0,class:"node-properties"},Jo={key:1,class:"no-selection"},Ho={class:"global-variables"},qo={class:"variables-header"},Go={class:"variables-list"},Fo={class:"variable-row"},Zo={key:0,class:"no-variables"},Qo={key:0,class:"edge-properties"},et={key:1,class:"no-selection"},Me=180,xe=80,De=30,ot=5e3,tt=5e3,lt={__name:"WorkflowDesigner",props:{workflow:{type:Object,default:()=>({})}},emits:["save","run"],setup(Oe,{emit:ge}){const V=Oe,ye=ge,g=[{type:"start",label:"å¼€å§‹èŠ‚ç‚¹",icon:"â–¶ï¸"},{type:"end",label:"ç»“æŸèŠ‚ç‚¹",icon:"â¹ï¸"},{type:"llm_call",label:"å¤§æ¨¡åž‹è°ƒç”¨",icon:"ðŸ¤–"},{type:"parallel",label:"å¹¶è¡ŒèŠ‚ç‚¹",icon:"ðŸ”€"},{type:"basic_branch",label:"åŸºç¡€åˆ†æ”¯",icon:"ðŸŒ¿"},{type:"llm_branch",label:"å¤§æ¨¡åž‹åˆ†æ”¯",icon:"ðŸŒ²"},{type:"math_operation",label:"æ•°å€¼è¿ç®—",icon:"ðŸ§®"},{type:"workflow_call",label:"å·¥ä½œæµè°ƒç”¨",icon:"ðŸ”—"},{type:"http_call",label:"HTTPè°ƒç”¨",icon:"ðŸŒ"}],_=c([]),k=c([]),p=c(null),x=c(null),S=c("node"),h=c(1),N=c(!1),I=c(null),B=c(0),X=c({x:0,y:0}),J=c(null),j=c(null),C=c({}),D=c([]),H=c(2),R=c(V.workflow.name||""),re=c(V.workflow.description||""),de=c(V.workflow.version||"1.0.0"),ce=c(!1),ee=c(null),ue=c({x:0,y:0}),Pe=e=>{const o=g.find(n=>n.type===e);return o?o.label:e},Ve=e=>{const o=g.find(n=>n.type===e);return o?o.icon:"ðŸ“¦"},z=e=>e==="basic_branch"||e==="llm_branch",oe=e=>e.type==="start"?[]:[{}],W=e=>e.type==="end"?[]:z(e.type)?(e.config||(e.config={}),e.config.outputPorts||(e.config.outputPorts=[{},{}]),e.config.outputPorts):[{}],_e=(e,o)=>xe/2,pe=(e,o)=>{const n=W(e);if(n.length===1)return xe/2;const r=(n.length-1)*De;return(xe-r)/2+o*De},he=e=>{const o=W(e);return pe(e,o.length-1)+De},m=e=>{z(e.type)&&(e.config||(e.config={}),e.config.outputPorts||(e.config.outputPorts=[{}]),e.config.outputPorts.push({}),P.success("å·²æ·»åŠ è¾“å‡ºç«¯å£"))},i=(e,o)=>{if(!z(e.type))return;const n=W(e);if(n.length<=1){P.warning("è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªè¾“å‡ºç«¯å£");return}n.splice(o,1),k.value=k.value.filter(r=>{if(r.fromNodeKey===e.nodeKey){if(r.fromPortIndex===o)return!1;r.fromPortIndex>o&&r.fromPortIndex--}return!0}),P.success("å·²åˆ é™¤è¾“å‡ºç«¯å£")},d=e=>{if(!p.value||!z(p.value.type))return;p.value.config||(p.value.config={}),p.value.config.outputPorts||(p.value.config.outputPorts=[{}]);const o=p.value.config.outputPorts.length;if(e>o)for(let n=o;n<e;n++)p.value.config.outputPorts.push({});else if(e<o){const n=o-e;for(let r=0;r<n;r++){const f=o-1-r;k.value=k.value.filter(a=>a.fromNodeKey===p.value.nodeKey&&a.fromPortIndex===f?!1:(a.fromNodeKey===p.value.nodeKey&&a.fromPortIndex>f&&a.fromPortIndex--,!0))}p.value.config.outputPorts=p.value.config.outputPorts.slice(0,e)}q()},w=(e,o,n)=>{const r=e.positionX,f=e.positionY;let a,b;return o==="input"?(a=r,b=f+_e()):(a=r+Me,b=f+pe(e,n)),{x:a,y:b}},te=e=>{const o=_.value.find($=>$.nodeKey===e.fromNodeKey),n=_.value.find($=>$.nodeKey===e.toNodeKey);if(!o||!n)return"";const r=w(o,"output",e.fromPortIndex||0),f=w(n,"input",e.toPortIndex||0),a=f.x-r.x,b=Math.max(100,Math.abs(a)*.5),G=r.x,ae=r.y,F=f.x,Z=f.y,ve=G+b,l=ae,O=F-b;return`M ${G} ${ae} C ${ve} ${l}, ${O} ${Z}, ${F} ${Z}`},le=()=>{if(!N.value||!I.value)return"";const e=_.value.find(O=>O.nodeKey===I.value);if(!e)return"";const o=w(e,"output",B.value),n=X.value,r=n.x-o.x,f=Math.max(100,Math.abs(r)*.5),a=o.x,b=o.y,G=n.x,ae=n.y,F=a+f,Z=b,ve=G-f;return`M ${a} ${b} C ${F} ${Z}, ${ve} ${ae}, ${G} ${ae}`},ne=e=>{const o=_.value.find(a=>a.nodeKey===e.fromNodeKey),n=_.value.find(a=>a.nodeKey===e.toNodeKey);if(!o||!n)return 0;const r=w(o,"output",e.fromPortIndex||0),f=w(n,"input",e.toPortIndex||0);return(r.x+f.x)/2},we=e=>{const o=_.value.find(a=>a.nodeKey===e.fromNodeKey),n=_.value.find(a=>a.nodeKey===e.toNodeKey);if(!o||!n)return 0;const r=w(o,"output",e.fromPortIndex||0),f=w(n,"input",e.toPortIndex||0);return(r.y+f.y)/2},Ne=(e,o)=>{e.dataTransfer.setData("application/json",JSON.stringify(o))},Ke=e=>{e.preventDefault()},$e=e=>{e.preventDefault();const o=e.dataTransfer.getData("application/json");if(o){const n=JSON.parse(o),r=J.value.getBoundingClientRect(),f=(e.clientX-r.left)/h.value-Me/2,a=(e.clientY-r.top)/h.value-xe/2,b={nodeKey:`${n.type}_${Date.now()}`,name:`${n.label} ${_.value.length+1}`,type:n.type,positionX:Math.max(0,f),positionY:Math.max(0,a),config:{}};z(n.type)&&(b.config.outputPorts=[{},{}],b.config.branchType="conditional",b.config.defaultBranch=""),_.value.push(b)}},be=e=>{p.value=e,x.value=null,C.value={...e.config},S.value="node",z(e.type)&&(H.value=W(e).length)},E=()=>{},q=()=>{p.value&&(p.value.config={...C.value})},je=e=>{var o;_.value=_.value.filter(n=>n.nodeKey!==e.nodeKey),k.value=k.value.filter(n=>n.fromNodeKey!==e.nodeKey&&n.toNodeKey!==e.nodeKey),((o=p.value)==null?void 0:o.nodeKey)===e.nodeKey&&(p.value=null,C.value={}),P.success("èŠ‚ç‚¹å·²åˆ é™¤")},We=(e,o)=>{if(N.value)return;e.stopPropagation(),ce.value=!0,ee.value=o;const n=J.value.getBoundingClientRect();e.currentTarget.getBoundingClientRect(),ue.value={x:(e.clientX-n.left)/h.value-o.positionX,y:(e.clientY-n.top)/h.value-o.positionY},be(o)},Le=e=>{(e.target===J.value||e.target.classList.contains("canvas"))&&(p.value=null,x.value=null,N.value&&fe())},Je=e=>{if(!J.value)return;const o=J.value.getBoundingClientRect();X.value={x:(e.clientX-o.left)/h.value,y:(e.clientY-o.top)/h.value},ce.value&&ee.value&&(ee.value.positionX=Math.max(0,X.value.x-ue.value.x),ee.value.positionY=Math.max(0,X.value.y-ue.value.y))},He=e=>{ce.value=!1,ee.value=null},Ue=(e,o,n,r=0)=>{if(e.stopPropagation(),N.value)if(n==="input"&&I.value!==o.nodeKey){const f={id:`edge_${Date.now()}_${Math.random()}`,fromNodeKey:I.value,toNodeKey:o.nodeKey,fromPortIndex:B.value,toPortIndex:r,conditionExpression:"true",variableMappings:"{}"};k.value.some(b=>b.fromNodeKey===f.fromNodeKey&&b.toNodeKey===f.toNodeKey&&b.fromPortIndex===f.fromPortIndex&&b.toPortIndex===f.toPortIndex)?P.warning("è¿žæŽ¥å·²å­˜åœ¨"):(k.value.push(f),P.success("è¿žæŽ¥å·²åˆ›å»º")),fe()}else n==="input"&&I.value===o.nodeKey&&(P.warning("ä¸èƒ½è¿žæŽ¥åˆ°è‡ªèº«"),fe());else n==="output"&&(N.value=!0,I.value=o.nodeKey,B.value=r)},Ye=(e,o,n,r=0)=>{e.stopPropagation(),n==="output"&&(N.value=!0,I.value=o.nodeKey,B.value=r)},fe=()=>{N.value=!1,I.value=null,B.value=0},Se=e=>{x.value=e,p.value=null,S.value="edge"},Be=()=>{},Ie=e=>{var o;k.value=k.value.filter(n=>n.id!==e.id),((o=x.value)==null?void 0:o.id)===e.id&&(x.value=null),P.success("è¿žæŽ¥çº¿å·²åˆ é™¤")},ze=e=>{const o=_.value.find(n=>n.nodeKey===e);return o?o.name:e},qe=()=>{h.value<2&&(h.value=Math.min(2,h.value+.1))},Ge=()=>{h.value>.5&&(h.value=Math.max(.5,h.value-.1))},Fe=()=>{h.value=1},Ze=()=>{const e={name:`å˜é‡${D.value.length+1}`,type:"string",initialValue:""};D.value.push(e)},Qe=e=>{D.value.splice(e,1)},Ce=()=>{},eo=()=>{var r,f;if(!R.value.trim()){P.warning("è¯·è¾“å…¥å·¥ä½œæµåç§°");return}const e=_.value.filter(a=>a.type==="start"),o=_.value.filter(a=>a.type==="end");if(e.length===0){P.warning("å·¥ä½œæµå¿…é¡»åŒ…å«ä¸€ä¸ªå¼€å§‹èŠ‚ç‚¹");return}if(o.length===0){P.warning("å·¥ä½œæµå¿…é¡»åŒ…å«ä¸€ä¸ªç»“æŸèŠ‚ç‚¹");return}const n={id:(r=V.workflow)==null?void 0:r.id,name:R.value,description:re.value,version:de.value,status:((f=V.workflow)==null?void 0:f.status)!==void 0?V.workflow.status:1,definition:{nodes:_.value.map(a=>({nodeKey:a.nodeKey,name:a.name,type:a.type,positionX:a.positionX,positionY:a.positionY,config:a.config||{}})),transitions:k.value.map(a=>({fromNodeKey:a.fromNodeKey,toNodeKey:a.toNodeKey,conditionExpression:a.conditionExpression||"true",variableMappings:a.variableMappings||"{}"})),globalVariables:D.value}};ye("save",n),P.success("å·¥ä½œæµå·²ä¿å­˜")},oo=()=>{ye("run",{nodes:_.value,edges:k.value}),P.success("å·¥ä½œæµå·²å¼€å§‹è¿è¡Œ")};return Te(()=>{V.workflow?(R.value=V.workflow.name||"",re.value=V.workflow.description||"",de.value=V.workflow.version||"1.0.0",V.workflow.definition?(_.value=Array.isArray(V.workflow.definition.nodes)?V.workflow.definition.nodes.map(e=>({...e,config:e.config||{}})):[],Array.isArray(V.workflow.definition.transitions)?k.value=V.workflow.definition.transitions.map(e=>({id:`edge_${Date.now()}_${Math.random()}`,fromNodeKey:e.fromNodeKey,toNodeKey:e.toNodeKey,fromPortIndex:e.fromPortIndex||0,toPortIndex:e.toPortIndex||0,conditionExpression:e.conditionExpression||"true",variableMappings:e.variableMappings||"{}"})):k.value=[],D.value=Array.isArray(V.workflow.definition.globalVariables)?V.workflow.definition.globalVariables:[]):(_.value=[],k.value=[],D.value=[])):(_.value=[],k.value=[],D.value=[]),document.addEventListener("keydown",e=>{e.key==="Escape"&&N.value&&fe(),e.key==="Delete"&&x.value&&Ie(x.value)})}),to(()=>{fe()}),lo(()=>V.workflow,e=>{e&&(R.value=e.name||"",re.value=e.description||"",de.value=e.version||"1.0.0",e.definition?(_.value=Array.isArray(e.definition.nodes)?e.definition.nodes.map(o=>({...o,config:o.config||{}})):[],Array.isArray(e.definition.transitions)?k.value=e.definition.transitions.map(o=>({id:`edge_${Date.now()}_${Math.random()}`,fromNodeKey:o.fromNodeKey,toNodeKey:o.toNodeKey,fromPortIndex:o.fromPortIndex||0,toPortIndex:o.toPortIndex||0,conditionExpression:o.conditionExpression||"true",variableMappings:o.variableMappings||"{}"})):k.value=[],D.value=Array.isArray(e.definition.globalVariables)?e.definition.globalVariables:[]):(_.value=[],k.value=[],D.value=[]))},{deep:!0}),(e,o)=>{const n=K("el-input"),r=K("el-button"),f=K("el-icon"),a=K("el-form-item"),b=K("el-option"),G=K("el-select"),ae=K("el-input-number"),F=K("el-form"),Z=K("el-tab-pane"),ve=K("el-tabs");return v(),y("div",bo,[u("div",ko,[u("div",xo,[t(n,{modelValue:R.value,"onUpdate:modelValue":o[0]||(o[0]=l=>R.value=l),placeholder:"è¾“å…¥å·¥ä½œæµåç§°",size:"small",style:{width:"200px","margin-right":"12px"}},null,8,["modelValue"])]),t(r,{type:"primary",onClick:eo},{default:s(()=>[...o[13]||(o[13]=[Y("ä¿å­˜å·¥ä½œæµ",-1)])]),_:1}),t(r,{onClick:oo},{default:s(()=>[...o[14]||(o[14]=[Y("è¿è¡Œå·¥ä½œæµ",-1)])]),_:1}),u("div",Po,[t(r,{onClick:qe,size:"small"},{default:s(()=>[...o[15]||(o[15]=[Y("æ”¾å¤§",-1)])]),_:1}),t(r,{onClick:Ge,size:"small"},{default:s(()=>[...o[16]||(o[16]=[Y("ç¼©å°",-1)])]),_:1}),t(r,{onClick:Fe,size:"small"},{default:s(()=>[...o[17]||(o[17]=[Y("é‡ç½®ç¼©æ”¾",-1)])]),_:1})])]),u("div",Vo,[u("div",ho,[o[18]||(o[18]=u("h3",null,"èŠ‚ç‚¹ç±»åž‹",-1)),u("div",No,[(v(),y(L,null,se(g,l=>u("div",{key:l.type,class:"node-item",draggable:"true",onDragstart:O=>Ne(O,l)},[u("div",$o,A(l.icon),1),u("div",Io,A(l.label),1)],40,Ko)),64))])]),u("div",{class:"canvas-container",ref_key:"canvasContainer",ref:J,onDragover:U(Ke,["prevent"]),onDrop:U($e,["prevent"]),onMousedown:Le,onMousemove:Je,onMouseup:He},[u("div",{class:"canvas",style:me({transform:`scale(${h.value})`,transformOrigin:"top left"})},[o[21]||(o[21]=u("div",{class:"grid-background"},null,-1)),(v(),y("svg",{class:"connections-layer",ref_key:"connectionsLayer",ref:j,width:ot,height:tt},[(v(!0),y(L,null,se(k.value,l=>{var O,M;return v(),y("g",{key:l.id},[u("path",{d:te(l),class:Ee(["connection-line",{"connection-line-selected":((O=x.value)==null?void 0:O.id)===l.id}]),onMousedown:U($=>Se(l),["stop"]),onClick:U($=>Se(l),["stop"])},null,42,Co),((M=x.value)==null?void 0:M.id)===l.id?(v(),y("circle",{key:0,cx:ne(l),cy:we(l),r:"8",class:"edge-delete-btn",onClick:U($=>Ie(l),["stop"])},null,8,Mo)):T("",!0)])}),128)),N.value?(v(),y("path",{key:0,d:le(),class:"connection-line connection-line-preview"},null,8,Do)):T("",!0)],512)),(v(!0),y(L,null,se(_.value,l=>{var O;return v(),y("div",{key:l.nodeKey,class:Ee(["workflow-node",{"node-selected":((O=p.value)==null?void 0:O.nodeKey)===l.nodeKey,"branch-node":z(l.type)}]),style:me({left:`${l.positionX}px`,top:`${l.positionY}px`,width:`${Me}px`}),onMousedown:U(M=>We(M,l),["stop"]),onClick:U(M=>be(l),["stop"])},[u("div",Oo,[(v(!0),y(L,null,se(oe(l),(M,$)=>(v(),y("div",{key:`input-${$}`,class:"port port-input","data-node-key":l.nodeKey,"data-port-index":$,style:me({top:`${_e()}px`}),onMousedown:U(Q=>Ye(Q,l,"input",$),["stop"]),onClick:U(Q=>Ue(Q,l,"input",$),["stop"])},[...o[19]||(o[19]=[u("div",{class:"port-circle port-circle-input"},null,-1)])],44,Uo))),128))]),u("div",Yo,[u("div",So,[u("div",Bo,A(Ve(l.type)),1),u("div",zo,A(l.name),1),t(r,{type:"danger",size:"small",circle:"",text:"",onClick:U(M=>je(l),["stop"])},{default:s(()=>[t(f,null,{default:s(()=>[t(ie(Ae))]),_:1})]),_:1},8,["onClick"])]),u("div",Ao,A(Pe(l.type)),1)]),u("div",Ro,[(v(!0),y(L,null,se(W(l),(M,$)=>(v(),y("div",{key:`output-${$}`,class:"port port-output","data-node-key":l.nodeKey,"data-port-index":$,style:me({top:`${pe(l,$)}px`}),onMousedown:U(Q=>Ye(Q,l,"output",$),["stop"]),onClick:U(Q=>Ue(Q,l,"output",$),["stop"])},[o[20]||(o[20]=u("div",{class:"port-circle port-circle-output"},null,-1)),z(l.type)&&W(l).length>1?(v(),y("div",{key:0,class:"port-delete-btn",onClick:U(Q=>i(l,$),["stop"])},[t(f,null,{default:s(()=>[t(ie(no))]),_:1})],8,Xo)):T("",!0)],44,To))),128)),z(l.type)?(v(),y("div",{key:0,class:"port-add-btn",style:me({top:`${he(l)}px`}),onClick:U(M=>m(l),["stop"])},[t(f,null,{default:s(()=>[t(ie(ao))]),_:1})],12,jo)):T("",!0)])],46,Eo)}),128))],4)],544),u("div",Wo,[t(ve,{modelValue:S.value,"onUpdate:modelValue":o[12]||(o[12]=l=>S.value=l),size:"small"},{default:s(()=>[t(Z,{label:"èŠ‚ç‚¹å±žæ€§",name:"node"},{default:s(()=>[p.value?(v(),y("div",Lo,[t(F,{"label-position":"top",size:"small"},{default:s(()=>[t(a,{label:"èŠ‚ç‚¹åç§°"},{default:s(()=>[t(n,{modelValue:p.value.name,"onUpdate:modelValue":o[1]||(o[1]=l=>p.value.name=l),onInput:E},null,8,["modelValue"])]),_:1}),t(a,{label:"èŠ‚ç‚¹ç±»åž‹"},{default:s(()=>[t(n,{modelValue:p.value.type,"onUpdate:modelValue":o[2]||(o[2]=l=>p.value.type=l),disabled:""},null,8,["modelValue"])]),_:1}),p.value.type==="llm_call"?(v(),y(L,{key:0},[t(a,{label:"ç³»ç»Ÿæç¤ºè¯"},{default:s(()=>[t(n,{modelValue:C.value.systemPrompt,"onUpdate:modelValue":o[3]||(o[3]=l=>C.value.systemPrompt=l),type:"textarea",rows:4,onInput:q},null,8,["modelValue"])]),_:1}),t(a,{label:"ç”¨æˆ·æç¤ºè¯æ¨¡æ¿"},{default:s(()=>[t(n,{modelValue:C.value.userPrompt,"onUpdate:modelValue":o[4]||(o[4]=l=>C.value.userPrompt=l),type:"textarea",rows:4,onInput:q,placeholder:"ä½¿ç”¨${å˜é‡å}æ¥å¼•ç”¨ä¸Šä¸‹æ–‡å˜é‡"},null,8,["modelValue"])]),_:1}),t(a,{label:"è¾“å‡ºå˜é‡å"},{default:s(()=>[t(n,{modelValue:C.value.outputVar,"onUpdate:modelValue":o[5]||(o[5]=l=>C.value.outputVar=l),onInput:q},null,8,["modelValue"])]),_:1})],64)):T("",!0),z(p.value.type)?(v(),y(L,{key:1},[t(a,{label:"åˆ†æ”¯ç±»åž‹"},{default:s(()=>[t(G,{modelValue:C.value.branchType,"onUpdate:modelValue":o[6]||(o[6]=l=>C.value.branchType=l),onChange:q},{default:s(()=>[t(b,{label:"æ¡ä»¶åˆ†æ”¯",value:"conditional"}),t(b,{label:"é»˜è®¤åˆ†æ”¯",value:"default"})]),_:1},8,["modelValue"])]),_:1}),t(a,{label:"é»˜è®¤åˆ†æ”¯"},{default:s(()=>[t(n,{modelValue:C.value.defaultBranch,"onUpdate:modelValue":o[7]||(o[7]=l=>C.value.defaultBranch=l),onInput:q},null,8,["modelValue"])]),_:1}),t(a,{label:"è¾“å‡ºç«¯å£æ•°é‡"},{default:s(()=>[t(ae,{modelValue:H.value,"onUpdate:modelValue":o[8]||(o[8]=l=>H.value=l),min:1,max:10,onChange:d},null,8,["modelValue"])]),_:1})],64)):T("",!0)]),_:1})])):(v(),y("div",Jo,[...o[22]||(o[22]=[u("p",null,"è¯·é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹",-1)])]))]),_:1}),t(Z,{label:"å…¨å±€å˜é‡",name:"variables"},{default:s(()=>[u("div",Ho,[u("div",qo,[o[24]||(o[24]=u("h3",null,"å…¨å±€å˜é‡",-1)),t(r,{type:"primary",size:"small",onClick:Ze},{default:s(()=>[...o[23]||(o[23]=[Y("æ·»åŠ å˜é‡",-1)])]),_:1})]),u("div",Go,[(v(!0),y(L,null,se(D.value,(l,O)=>(v(),y("div",{key:O,class:"variable-item"},[t(F,{"label-position":"top",size:"mini"},{default:s(()=>[u("div",Fo,[t(a,{label:"å˜é‡å","label-width":60},{default:s(()=>[t(n,{modelValue:l.name,"onUpdate:modelValue":M=>l.name=M,onInput:Ce},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),t(a,{label:"ç±»åž‹","label-width":40},{default:s(()=>[t(G,{modelValue:l.type,"onUpdate:modelValue":M=>l.type=M,onChange:Ce,style:{width:"100px"}},{default:s(()=>[t(b,{label:"å­—ç¬¦ä¸²",value:"string"}),t(b,{label:"æ•´æ•°",value:"integer"}),t(b,{label:"æµ®ç‚¹æ•°",value:"double"})]),_:1},8,["modelValue","onUpdate:modelValue"])]),_:2},1024),t(a,{label:"åˆå§‹å€¼","label-width":60},{default:s(()=>[t(n,{modelValue:l.initialValue,"onUpdate:modelValue":M=>l.initialValue=M,onInput:Ce},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),t(r,{type:"danger",size:"mini",circle:"",onClick:M=>Qe(O),style:{"margin-top":"22px"}},{default:s(()=>[t(f,null,{default:s(()=>[t(ie(Ae))]),_:1})]),_:1},8,["onClick"])])]),_:2},1024)]))),128)),D.value.length===0?(v(),y("div",Zo,[...o[25]||(o[25]=[u("p",null,"æš‚æ— å…¨å±€å˜é‡ï¼Œç‚¹å‡»æ·»åŠ æŒ‰é’®åˆ›å»º",-1)])])):T("",!0)])])]),_:1}),t(Z,{label:"è¿žæŽ¥çº¿å±žæ€§",name:"edge"},{default:s(()=>[x.value?(v(),y("div",Qo,[t(F,{"label-position":"top",size:"small"},{default:s(()=>[t(a,{label:"èµ·å§‹èŠ‚ç‚¹"},{default:s(()=>[t(n,{value:ze(x.value.fromNodeKey),disabled:""},null,8,["value"])]),_:1}),t(a,{label:"ç›®æ ‡èŠ‚ç‚¹"},{default:s(()=>[t(n,{value:ze(x.value.toNodeKey),disabled:""},null,8,["value"])]),_:1}),t(a,{label:"æ¡ä»¶è¡¨è¾¾å¼"},{default:s(()=>[t(n,{modelValue:x.value.conditionExpression,"onUpdate:modelValue":o[9]||(o[9]=l=>x.value.conditionExpression=l),onInput:Be,placeholder:"ä¾‹å¦‚ï¼šanswer.length > 100"},null,8,["modelValue"])]),_:1}),t(a,{label:"å˜é‡æ˜ å°„"},{default:s(()=>[t(n,{modelValue:x.value.variableMappings,"onUpdate:modelValue":o[10]||(o[10]=l=>x.value.variableMappings=l),type:"textarea",rows:3,onInput:Be,placeholder:"JSONæ ¼å¼ï¼Œä¾‹å¦‚ï¼š{}"},null,8,["modelValue"])]),_:1}),t(a,null,{default:s(()=>[t(r,{type:"danger",onClick:o[11]||(o[11]=l=>Ie(x.value))},{default:s(()=>[...o[26]||(o[26]=[Y("åˆ é™¤è¿žæŽ¥çº¿",-1)])]),_:1})]),_:1})]),_:1})])):(v(),y("div",et,[...o[27]||(o[27]=[u("p",null,"è¯·é€‰æ‹©ä¸€æ¡è¿žæŽ¥çº¿",-1)])]))]),_:1})]),_:1},8,["modelValue"])])])])}}},nt=Xe(lt,[["__scopeId","data-v-cde59966"]]),at={class:"workflow-designer-view"},st={class:"view-header"},it={class:"header-actions"},ut={class:"designer-wrapper"},rt={class:"dialog-footer"},dt={class:"execution-result"},ct={class:"execution-status"},pt={key:0,class:"execution-progress"},ft={class:"progress-text"},vt={class:"execution-logs"},mt={class:"log-time"},gt={class:"log-node"},yt={class:"log-message"},_t={key:0,class:"no-logs"},wt={key:1,class:"execution-result-data"},bt={class:"result-text"},kt={class:"dialog-footer"},xt={__name:"WorkflowDesignerView",setup(Oe){const ge=co(),V=io(),ye=vo(),g=c({id:null,name:"",description:"",version:"1.0.0",status:1,definition:{nodes:[],transitions:[],globalVariables:[]}}),_=c(!1),k=c(!1),p=c(!1),x=c(!1),S=so({name:"",inputParams:"{}"}),h=c(!1),N=c(null),I=c("running"),B=c("å·¥ä½œæµæ­£åœ¨æ‰§è¡Œä¸­..."),X=c(""),J=c(0),j=c([]),C=c({}),D=c(""),H=c(null),R=c(!1),re=()=>{ge.push("/workflows")},de=()=>{po.confirm("ç¡®å®šè¦é‡ç½®å·¥ä½œæµå—ï¼Ÿè¿™å°†æ¸…é™¤å½“å‰æ‰€æœ‰è®¾è®¡å†…å®¹ã€‚","è­¦å‘Š",{confirmButtonText:"ç¡®å®š",cancelButtonText:"å–æ¶ˆ",type:"warning"}).then(()=>{g.value={id:g.value.id,name:"",description:"",version:"1.0.0",status:1,definition:{nodes:[],transitions:[],globalVariables:[]}},P.success("å·¥ä½œæµå·²é‡ç½®")}).catch(()=>{})},ce=m=>{console.log("=== è°ƒè¯•ï¼šå¼€å§‹åŠ è½½å·¥ä½œæµå®šä¹‰ ==="),console.log("åŠ è½½çš„å·¥ä½œæµID:",m),mo(m).then(i=>{var w,te,le;console.log("=== è°ƒè¯•ï¼šèŽ·å–åˆ°å·¥ä½œæµå®šä¹‰ ==="),console.log("APIå“åº”å®Œæ•´æ•°æ®:",i);const d=i.data||i;if(console.log("workflowData:",d),console.log("workflowData.hasOwnProperty(jsonDefinition):",d.hasOwnProperty("jsonDefinition")),console.log("workflowData.jsonDefinition:",d.jsonDefinition),console.log("workflowData.hasOwnProperty(definition):",d.hasOwnProperty("definition")),console.log("workflowData.definition:",d.definition),d.jsonDefinition)try{const ne=typeof d.jsonDefinition=="string"?JSON.parse(d.jsonDefinition):d.jsonDefinition;d.definition=ne,console.log("è§£æžåŽçš„definition:",d.definition)}catch(ne){console.error("=== è°ƒè¯•ï¼šè§£æžjsonDefinitionå¤±è´¥ ==="),console.error("é”™è¯¯ä¿¡æ¯:",ne),d.definition={nodes:[],transitions:[],globalVariables:[]}}else d.definition={nodes:[],transitions:[],globalVariables:[]};g.value=d,console.log("=== è°ƒè¯•ï¼šå·¥ä½œæµæ•°æ®èµ‹å€¼å®Œæˆ ==="),console.log("æœ€ç»ˆå·¥ä½œæµæ•°æ®:",g.value),console.log("æœ€ç»ˆdefinition:",g.value.definition),g.value.definition&&(!g.value.definition.transitions&&g.value.definition.edges&&(g.value.definition.transitions=g.value.definition.edges,delete g.value.definition.edges),g.value.definition.globalVariables||(g.value.definition.globalVariables=[]),console.log("æœ€ç»ˆèŠ‚ç‚¹æ•°é‡:",(w=g.value.definition.nodes)==null?void 0:w.length),console.log("æœ€ç»ˆè½¬æ¢æ•°é‡:",(te=g.value.definition.transitions)==null?void 0:te.length),console.log("æœ€ç»ˆå…¨å±€å˜é‡æ•°é‡:",(le=g.value.definition.globalVariables)==null?void 0:le.length))}).catch(i=>{console.error("=== è°ƒè¯•ï¼šåŠ è½½å·¥ä½œæµå¤±è´¥ ==="),console.error("é”™è¯¯ä¿¡æ¯:",i),P.error("åŠ è½½å·¥ä½œæµå¤±è´¥"),console.error("åŠ è½½å·¥ä½œæµå¤±è´¥:",i),g.value={id:m,name:"ç¤ºä¾‹å·¥ä½œæµ",description:"è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹å·¥ä½œæµ",version:"1.0.0",status:1,definition:{nodes:[{nodeKey:"start_node",name:"å¼€å§‹èŠ‚ç‚¹",type:"start",positionX:100,positionY:200,config:{}},{nodeKey:"llm_call_1",name:"å¤§æ¨¡åž‹è°ƒç”¨",type:"llm_call",positionX:300,positionY:200,config:{systemPrompt:"ä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹",userPrompt:"è¯·å›žç­”ï¼š${question}",outputVar:"answer"}},{nodeKey:"end_node",name:"ç»“æŸèŠ‚ç‚¹",type:"end",positionX:500,positionY:200,config:{}}],transitions:[{fromNodeKey:"start_node",toNodeKey:"llm_call_1",conditionExpression:"true",variableMappings:"{}"},{fromNodeKey:"llm_call_1",toNodeKey:"end_node",conditionExpression:"true",variableMappings:"{}"}],globalVariables:[{name:"question",type:"string",initialValue:"è¯·è¾“å…¥ä½ çš„é—®é¢˜"},{name:"answer",type:"string",initialValue:""}]}}})},ee=m=>{k.value=!0,console.log("=== è°ƒè¯•ï¼šå¼€å§‹ä¿å­˜å·¥ä½œæµ ==="),console.log("ä¿å­˜çš„å·¥ä½œæµæ•°æ®:",m),(_.value?_o(m.id,m):wo(m)).then(d=>{console.log("=== è°ƒè¯•ï¼šä¿å­˜å·¥ä½œæµæˆåŠŸ ==="),console.log("APIå“åº”æ•°æ®:",d),P.success("å·¥ä½œæµå·²ä¿å­˜");const w=d.data||d;w?(g.value=w,_.value=!0,console.log("=== è°ƒè¯•ï¼šå·¥ä½œæµæ•°æ®æ›´æ–°å®Œæˆ ==="),console.log("æ›´æ–°åŽçš„å·¥ä½œæµæ•°æ®:",g.value),console.log("æ›´æ–°åŽçš„definition:",g.value.definition)):(console.log("=== è°ƒè¯•ï¼šå·¥ä½œæµæ•°æ®æ›´æ–°å®Œæˆ ==="),console.log("APIè¿”å›žæ•°æ®ä¸ºnullï¼Œä¿æŒåŽŸæœ‰å·¥ä½œæµæ•°æ®"))}).catch(d=>{console.error("=== è°ƒè¯•ï¼šä¿å­˜å·¥ä½œæµå¤±è´¥ ==="),console.error("é”™è¯¯ä¿¡æ¯:",d),P.error("ä¿å­˜å·¥ä½œæµå¤±è´¥"),console.error("ä¿å­˜å·¥ä½œæµå¤±è´¥:",d)}).finally(()=>{k.value=!1})},ue=()=>{x.value=!0,S.name=g.value.name+"_å®žä¾‹",S.inputParams="{}"},Pe=m=>{ue()},Ve=()=>{if(p.value=!0,x.value=!1,!g.value.id){P.error("å·¥ä½œæµæœªä¿å­˜ï¼Œæ— æ³•è¿è¡Œ"),p.value=!1;return}let m={};try{m=JSON.parse(S.inputParams)}catch{P.error("è¾“å…¥å‚æ•°æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„JSONæ ¼å¼"),p.value=!1;return}go(g.value.id,m).then(i=>{P.success("å·¥ä½œæµå·²å¼€å§‹è¿è¡Œ");const d=i.data||i;d&&d.id&&(N.value=d.id,h.value=!0,I.value="running",B.value="å·¥ä½œæµæ­£åœ¨æ‰§è¡Œä¸­...",X.value="",j.value=[],C.value={},D.value="",z())}).catch(i=>{P.error("è¿è¡Œå·¥ä½œæµå¤±è´¥"),console.error("è¿è¡Œå·¥ä½œæµå¤±è´¥:",i)}).finally(()=>{p.value=!1})},z=()=>{R.value||(R.value=!0,W(),H.value=setInterval(()=>{W()},2e3))},oe=()=>{R.value&&(R.value=!1,H.value&&(clearInterval(H.value),H.value=null))},W=()=>{if(!N.value){oe();return}yo(N.value).then(m=>{const i=m.data||m;_e(i)}).catch(m=>{console.error("èŽ·å–å·¥ä½œæµçŠ¶æ€å¤±è´¥:",m),ke(N.value).then(i=>{const d=i.data||i;j.value=d})})},_e=m=>{var i;switch(I.value=m.status||"unknown",I.value){case"completed":B.value="å·¥ä½œæµæ‰§è¡Œå®Œæˆ",X.value="",oe(),C.value=m,D.value=JSON.stringify(m.outputParams||{},null,2),ke(N.value).then(d=>{const w=d.data||d;j.value=w});break;case"failed":B.value="å·¥ä½œæµæ‰§è¡Œå¤±è´¥",X.value="",oe(),C.value=m,D.value=JSON.stringify(m.outputParams||{},null,2),ke(N.value).then(d=>{const w=d.data||d;j.value=w});break;case"running":B.value="å·¥ä½œæµæ­£åœ¨æ‰§è¡Œä¸­...",X.value=((i=m.currentNode)==null?void 0:i.name)||"æœªçŸ¥èŠ‚ç‚¹",ke(N.value).then(d=>{const w=d.data||d;j.value=w});break;default:B.value=`å·¥ä½œæµçŠ¶æ€ï¼š${I.value}`}},pe=()=>{oe(),h.value=!1,N.value=null},he=()=>{oe(),h.value=!1,ge.push(`/workflow-instances/${N.value}`)};return Te(()=>{const m=V.query.id;m?(_.value=!0,ce(Number(m))):g.value={id:null,name:"",description:"",version:"1.0.0",status:1,definition:{nodes:[],transitions:[],globalVariables:[]}}}),(m,i)=>{const d=K("el-icon"),w=K("el-button"),te=K("el-input"),le=K("el-form-item"),ne=K("el-form"),we=K("el-dialog"),Ne=K("el-alert"),Ke=K("el-progress"),$e=K("el-scrollbar"),be=K("el-card");return v(),Re(fo,{userInfo:ie(ye).userInfo},{default:s(()=>[u("div",at,[u("div",st,[u("h1",null,A(_.value?"ç¼–è¾‘å·¥ä½œæµ":"åˆ›å»ºå·¥ä½œæµ"),1),u("div",it,[t(w,{onClick:re},{default:s(()=>[t(d,null,{default:s(()=>[t(ie(uo))]),_:1}),i[5]||(i[5]=Y(" è¿”å›žåˆ—è¡¨ ",-1))]),_:1}),t(w,{type:"warning",onClick:de},{default:s(()=>[...i[6]||(i[6]=[Y("é‡ç½®",-1)])]),_:1}),t(w,{type:"success",onClick:ue,loading:p.value},{default:s(()=>[t(d,null,{default:s(()=>[t(ie(ro))]),_:1}),i[7]||(i[7]=Y(" è¿è¡Œå·¥ä½œæµ ",-1))]),_:1},8,["loading"])])]),u("div",ut,[t(nt,{workflow:g.value,onSave:ee,onRun:Pe},null,8,["workflow"])]),t(we,{modelValue:x.value,"onUpdate:modelValue":i[3]||(i[3]=E=>x.value=E),title:"è¿è¡Œå·¥ä½œæµ",width:"500px",center:""},{footer:s(()=>[u("span",rt,[t(w,{onClick:i[2]||(i[2]=E=>x.value=!1)},{default:s(()=>[...i[8]||(i[8]=[Y("å–æ¶ˆ",-1)])]),_:1}),t(w,{type:"primary",onClick:Ve},{default:s(()=>[...i[9]||(i[9]=[Y("ç¡®å®šè¿è¡Œ",-1)])]),_:1})])]),default:s(()=>[t(ne,{"label-position":"top",size:"small"},{default:s(()=>[t(le,{label:"å·¥ä½œæµåç§°"},{default:s(()=>[t(te,{modelValue:S.name,"onUpdate:modelValue":i[0]||(i[0]=E=>S.name=E),placeholder:"è¾“å…¥å·¥ä½œæµå®žä¾‹åç§°"},null,8,["modelValue"])]),_:1}),t(le,{label:"è¾“å…¥å‚æ•°"},{default:s(()=>[t(te,{modelValue:S.inputParams,"onUpdate:modelValue":i[1]||(i[1]=E=>S.inputParams=E),type:"textarea",rows:6,placeholder:'è¾“å…¥JSONæ ¼å¼çš„å‚æ•°ï¼Œä¾‹å¦‚ï¼š{"question": "ä½ å¥½"}'},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(we,{modelValue:h.value,"onUpdate:modelValue":i[4]||(i[4]=E=>h.value=E),title:"å·¥ä½œæµæ‰§è¡Œç»“æžœ",width:"700px",center:""},{footer:s(()=>[u("span",kt,[t(w,{onClick:pe},{default:s(()=>[...i[12]||(i[12]=[Y("å…³é—­",-1)])]),_:1}),N.value?(v(),Re(w,{key:0,type:"primary",onClick:he},{default:s(()=>[...i[13]||(i[13]=[Y("æŸ¥çœ‹è¯¦æƒ…",-1)])]),_:1})):T("",!0)])]),default:s(()=>[u("div",dt,[u("div",ct,[t(Ne,{type:I.value==="completed"?"success":I.value==="failed"?"error":"info",title:B.value,"show-icon":""},null,8,["type","title"])]),I.value==="running"?(v(),y("div",pt,[t(Ke,{percentage:J.value,status:"warning",indeterminate:!0},null,8,["percentage"]),u("div",ft,"å½“å‰æ‰§è¡ŒèŠ‚ç‚¹ï¼š"+A(X.value||"æœªçŸ¥"),1)])):T("",!0),u("div",vt,[i[10]||(i[10]=u("h4",null,"æ‰§è¡Œæ—¥å¿—",-1)),t($e,{height:"200px",class:"logs-scrollbar"},{default:s(()=>[(v(!0),y(L,null,se(j.value,(E,q)=>(v(),y("div",{key:q,class:"log-item"},[u("span",mt,A(E.timestamp),1),u("span",gt,A(E.nodeName),1),u("span",{class:Ee(["log-status",E.status])},A(E.status),3),u("span",yt,A(E.message),1)]))),128)),j.value.length===0?(v(),y("div",_t,"æš‚æ— æ‰§è¡Œæ—¥å¿—")):T("",!0)]),_:1})]),I.value!=="running"?(v(),y("div",wt,[i[11]||(i[11]=u("h4",null,"æ‰§è¡Œç»“æžœ",-1)),t(be,null,{default:s(()=>[u("pre",bt,A(D.value),1)]),_:1})])):T("",!0)])]),_:1},8,["modelValue"])])]),_:1},8,["userInfo"])}}},$t=Xe(xt,[["__scopeId","data-v-d8a5e98b"]]);export{$t as default};
