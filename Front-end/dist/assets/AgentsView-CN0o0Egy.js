import{r as i,a as G,h as Ve,i as S,o as c,w as n,b as u,d as l,f as g,k as P,x as he,e as d,c as z,m as Ce,t as k,y as Je,z as Se,A as Y,j as K,F as E,E as r,B as Pe}from"./index-DX3WRIvF.js";import{L as ze}from"./Layout-Caa_pSpe.js";import{u as Ne}from"./userStore-B-BM9dwW.js";import{a as b}from"./agent-CJcu8WMq.js";import{k as ke}from"./knowledge-4HSt9JMS.js";import{_ as Te}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ie={class:"agents-container"},Oe={class:"page-header"},Ue={key:0,class:"loading-container"},Be={class:"agent-name"},Ke={class:"name-text"},Ee={class:"agent-desc"},De={key:2,class:"pagination-container"},Fe={style:{width:"100%"}},Le={style:{"margin-bottom":"8px",display:"flex","align-items":"center",gap:"8px","flex-wrap":"wrap"}},Me={style:{width:"100%"}},$e={style:{"margin-bottom":"8px",display:"flex","align-items":"center",gap:"8px","flex-wrap":"wrap"}},je={style:{width:"100%"}},Re={style:{"margin-bottom":"8px",display:"flex","align-items":"center",gap:"8px","flex-wrap":"wrap"}},Ge={key:1,style:{"font-size":"12px",color:"#909399"}},Ye={class:"dialog-footer"},qe="api_config_templates",He="plugin_config_templates",Qe={__name:"AgentsView",setup(We){const O=Ne(),w=i([]),T=i(!1),A=i(!1),x=i("create"),v=i(null),N=i(null),D=i([]),V=i([]),h=i(null),U=i([]),B=i([]),F=i(""),L=i(""),q=i(!1),H=i(!1),Q=i(""),W=i(""),p=G({currentPage:1,pageSize:10,total:0}),s=G({name:"",description:"",type:"general",apiConfig:"",systemPrompt:"",pluginsJson:"",configJson:"{}",status:1}),X={name:[{required:!0,message:"请输入智能体名称",trigger:"blur"},{min:2,max:50,message:"名称长度在 2 到 50 个字符",trigger:"blur"}],description:[{max:200,message:"描述不能超过 200 个字符",trigger:"blur"}],apiConfig:[{max:500,message:"API配置不能超过 500 个字符",trigger:"blur"}],systemPrompt:[{max:2e3,message:"系统提示词不能超过 2000 个字符",trigger:"blur"}],pluginsJson:[{validator:(a,e,o)=>{if(e)try{JSON.parse(e),o()}catch{o(new Error("请输入有效的JSON格式"))}else o()},trigger:"blur"}],configJson:[{validator:(a,e,o)=>{if(e)try{JSON.parse(e),o()}catch{o(new Error("请输入有效的JSON格式"))}else o()},trigger:"blur"}]},Z=()=>{try{const a=localStorage.getItem(qe);return a?JSON.parse(a):[]}catch(a){return console.error("加载 API 模板失败:",a),[]}},ee=()=>{try{const a=localStorage.getItem(He);return a?JSON.parse(a):[]}catch(a){return console.error("加载插件模板失败:",a),[]}},te=()=>{if(!s.apiConfig){r.warning("当前 API 配置为空，无法保存为模板");return}Q.value="",q.value=!0},ae=()=>{if(!s.pluginsJson){r.warning("当前插件配置为空，无法保存为模板");return}W.value="",H.value=!0},le=a=>{const e=U.value.find(o=>o.name===a);e&&(s.apiConfig=e.config,r.success("已应用 API 模板"))},oe=a=>{const e=B.value.find(o=>o.name===a);e&&(s.pluginsJson=e.config,r.success("已应用插件模板"))},ne=async()=>{try{const a=await ke.listKnowledgeBases();D.value=Array.isArray(a)?a:a.data||[]}catch(a){console.error("获取知识库列表失败:",a)}},M=async()=>{if(!v.value){V.value=[];return}try{const a=await b.getAgentKnowledge(v.value);V.value=Array.isArray(a)?a:a.data||[]}catch(a){console.error("获取 Agent 知识库失败:",a),V.value=[]}},se=async()=>{if(!v.value){r.warning("请先保存 Agent，再绑定知识库");return}if(!h.value){r.warning("请选择要绑定的知识库");return}try{await b.addAgentKnowledge(v.value,h.value),r.success("绑定知识库成功"),await M()}catch(a){console.error("绑定知识库失败:",a),r.error("绑定知识库失败，请稍后重试")}},C=async()=>{T.value=!0;try{const a={page:p.currentPage,pageSize:p.pageSize},e=await b.getAgents(a);e&&e.data?(w.value=Array.isArray(e.data)?e.data:[],p.total=e.total||0):(w.value=Array.isArray(e)?e:[],p.total=w.value.length),console.log("获取智能体列表成功:",w.value)}catch(a){console.error("获取智能体列表失败:",a),r.error("获取智能体列表失败，请稍后重试"),w.value=[],p.total=0}finally{T.value=!1}},re=()=>{x.value="create",v.value=null,Object.assign(s,{name:"",description:"",type:"general",apiConfig:"",systemPrompt:"",pluginsJson:"",configJson:"{}",status:1}),V.value=[],h.value=null,N.value&&N.value.resetFields(),A.value=!0},ie=async a=>{x.value="edit",v.value=a.id;try{const e=await b.getAgentById(a.id),o=e.data||e;Object.assign(s,{name:o.name||"",description:o.description||"",type:o.type||"general",apiConfig:o.apiConfig||"",systemPrompt:o.systemPrompt||"",pluginsJson:o.pluginsJson||"",configJson:typeof o.configJson=="string"?o.configJson:JSON.stringify(o.configJson||{},null,2),status:o.status??1}),await M(),A.value=!0}catch(e){console.error("获取智能体详情失败:",e),r.error("获取智能体详情失败，请稍后重试")}},ue=(a,e)=>{Pe.confirm(`确定要删除智能体「${e}」吗？此操作不可恢复。`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await b.deleteAgent(a),r.success("删除成功"),await C()}catch(o){console.error("删除智能体失败:",o),r.error("删除失败，请稍后重试")}}).catch(()=>{})},de=async()=>{N.value&&await N.value.validate(async a=>{if(a)try{const e={...s,pluginsJson:s.pluginsJson||null,configJson:s.configJson||null};if(x.value==="create"){const o=await b.createAgent(e);r.success("创建成功"),await C()}else await b.updateAgent(v.value,e),r.success("更新成功"),await C();A.value=!1}catch(e){console.error(`${x.value==="create"?"创建":"更新"}智能体失败:`,e),r.error(`${x.value==="create"?"创建":"更新"}失败，请稍后重试`)}})},pe=a=>{const e=new FileReader;return e.onload=o=>{const m=o.target.result.trim();s.apiConfig=m,r.success("API配置导入成功")},e.onerror=()=>{r.error("文件读取失败")},e.readAsText(a),!1},ge=a=>{const e=new FileReader;return e.onload=o=>{try{const m=o.target.result;JSON.parse(m),s.pluginsJson=m,r.success("JSON文件导入成功")}catch{r.error("无效的JSON文件，请检查文件格式")}},e.onerror=()=>{r.error("文件读取失败")},e.readAsText(a),!1},ce=a=>{p.pageSize=a,p.currentPage=1,C()},me=a=>{p.currentPage=a,C()},fe=a=>({general:"primary",knowledge:"success",task:"warning",creative:"info"})[a]||"default",ye=a=>a?new Date(a).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-";return Ve(async()=>{console.log("Agent管理页面已加载"),O.initialized||await O.initializeUserInfo(),U.value=Z(),B.value=ee(),await C(),await ne()}),(a,e)=>{const o=d("el-button"),m=d("el-skeleton"),f=d("el-table-column"),$=d("el-tag"),j=d("el-table"),ve=d("el-pagination"),we=d("el-card"),J=d("el-input"),y=d("el-form-item"),_=d("el-option"),I=d("el-select"),R=d("el-upload"),_e=d("el-switch"),be=d("el-form"),Ae=d("el-dialog");return c(),S(ze,{userInfo:P(O).userInfo},{default:n(()=>[u("div",Ie,[u("div",Oe,[e[16]||(e[16]=u("h1",null,"我的智能体",-1)),l(o,{type:"primary",onClick:re,icon:P(he)},{default:n(()=>[...e[15]||(e[15]=[g("创建智能体",-1)])]),_:1},8,["icon"])]),l(we,{class:"agents-card"},{default:n(()=>[T.value?(c(),z("div",Ue,[l(m,{rows:5,animated:""})])):(c(),S(j,{key:1,data:w.value,style:{width:"100%"},"empty-text":"暂无智能体数据"},{default:n(()=>[l(f,{prop:"id",label:"ID",width:"180"}),l(f,{prop:"name",label:"名称","min-width":"150"},{default:n(t=>[u("div",Be,[u("div",Ke,k(t.row.name),1),u("div",Ee,k(t.row.description||"无描述"),1)])]),_:1}),l(f,{prop:"type",label:"类型",width:"100"},{default:n(t=>[l($,{type:fe(t.row.type),effect:"light"},{default:n(()=>[g(k(t.row.type||"默认"),1)]),_:2},1032,["type"])]),_:1}),l(f,{prop:"createdAt",label:"创建时间",width:"180"},{default:n(t=>[g(k(ye(t.row.createdAt)),1)]),_:1}),l(f,{prop:"status",label:"状态",width:"100"},{default:n(t=>[l($,{type:t.row.status===1?"success":"danger",effect:"light"},{default:n(()=>[g(k(t.row.status===1?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),l(f,{label:"操作",width:"180",fixed:"right"},{default:n(t=>[l(o,{type:"primary",size:"small",onClick:xe=>ie(t.row),icon:P(Je)},{default:n(()=>[...e[17]||(e[17]=[g(" 编辑 ",-1)])]),_:1},8,["onClick","icon"]),l(o,{type:"danger",size:"small",onClick:xe=>ue(t.row.id,t.row.name),icon:P(Se)},{default:n(()=>[...e[18]||(e[18]=[g(" 删除 ",-1)])]),_:1},8,["onClick","icon"])]),_:1})]),_:1},8,["data"])),!T.value&&w.value.length>0?(c(),z("div",De,[l(ve,{"current-page":p.currentPage,"onUpdate:currentPage":e[0]||(e[0]=t=>p.currentPage=t),"page-size":p.pageSize,"onUpdate:pageSize":e[1]||(e[1]=t=>p.pageSize=t),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:p.total,onSizeChange:ce,onCurrentChange:me},null,8,["current-page","page-size","total"])])):Ce("",!0)]),_:1}),l(Ae,{modelValue:A.value,"onUpdate:modelValue":e[14]||(e[14]=t=>A.value=t),title:x.value==="create"?"创建智能体":"编辑智能体",width:"500px"},{footer:n(()=>[u("span",Ye,[l(o,{onClick:e[13]||(e[13]=t=>A.value=!1)},{default:n(()=>[...e[26]||(e[26]=[g("取消",-1)])]),_:1}),l(o,{type:"primary",onClick:de},{default:n(()=>[...e[27]||(e[27]=[g("确定",-1)])]),_:1})])]),default:n(()=>[l(be,{ref_key:"agentFormRef",ref:N,model:s,rules:X,"label-width":"100px"},{default:n(()=>[l(y,{label:"名称",prop:"name"},{default:n(()=>[l(J,{modelValue:s.name,"onUpdate:modelValue":e[2]||(e[2]=t=>s.name=t),placeholder:"请输入智能体名称",maxlength:"50"},null,8,["modelValue"])]),_:1}),l(y,{label:"描述",prop:"description"},{default:n(()=>[l(J,{modelValue:s.description,"onUpdate:modelValue":e[3]||(e[3]=t=>s.description=t),type:"textarea",placeholder:"请输入智能体描述",rows:"3",maxlength:"200"},null,8,["modelValue"])]),_:1}),l(y,{label:"类型",prop:"type"},{default:n(()=>[l(I,{modelValue:s.type,"onUpdate:modelValue":e[4]||(e[4]=t=>s.type=t),placeholder:"请选择智能体类型"},{default:n(()=>[l(_,{label:"通用助手",value:"general"}),l(_,{label:"知识库助手",value:"knowledge"}),l(_,{label:"任务助手",value:"task"}),l(_,{label:"创意助手",value:"creative"})]),_:1},8,["modelValue"])]),_:1}),l(y,{label:"API配置",prop:"apiConfig"},{default:n(()=>[u("div",Fe,[u("div",Le,[l(R,{"show-file-list":!1,"before-upload":pe,accept:".json,.txt"},{default:n(()=>[l(o,{size:"small",type:"primary",icon:P(Y)},{default:n(()=>[...e[19]||(e[19]=[g("导入配置文件",-1)])]),_:1},8,["icon"])]),_:1}),l(o,{size:"small",onClick:te},{default:n(()=>[...e[20]||(e[20]=[g("保存为模板",-1)])]),_:1}),l(I,{modelValue:F.value,"onUpdate:modelValue":e[5]||(e[5]=t=>F.value=t),placeholder:"选择模板应用",clearable:"",style:{width:"200px"},onChange:le},{default:n(()=>[(c(!0),z(E,null,K(U.value,t=>(c(),S(_,{key:t.name,label:t.name,value:t.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),e[21]||(e[21]=u("span",{style:{"margin-left":"0",color:"#909399","font-size":"12px",display:"block","margin-bottom":"4px"}},' 支持直接填写API Key，或JSON格式: {"apiKey": "sk-xxx", "model": "deepseek-chat"} ',-1)),l(J,{modelValue:s.apiConfig,"onUpdate:modelValue":e[6]||(e[6]=t=>s.apiConfig=t),type:"textarea",placeholder:"请输入API配置（直接填写API Key或JSON格式）",rows:"3"},null,8,["modelValue"])])]),_:1}),l(y,{label:"系统提示词",prop:"systemPrompt"},{default:n(()=>[l(J,{modelValue:s.systemPrompt,"onUpdate:modelValue":e[7]||(e[7]=t=>s.systemPrompt=t),type:"textarea",placeholder:"请输入系统提示词",rows:"4"},null,8,["modelValue"])]),_:1}),l(y,{label:"插件配置",prop:"pluginsJson"},{default:n(()=>[u("div",Me,[u("div",$e,[l(R,{"show-file-list":!1,"before-upload":ge,accept:".json"},{default:n(()=>[l(o,{size:"small",type:"primary",icon:P(Y)},{default:n(()=>[...e[22]||(e[22]=[g("导入JSON文件",-1)])]),_:1},8,["icon"])]),_:1}),l(o,{size:"small",onClick:ae},{default:n(()=>[...e[23]||(e[23]=[g("保存为模板",-1)])]),_:1}),l(I,{modelValue:L.value,"onUpdate:modelValue":e[8]||(e[8]=t=>L.value=t),placeholder:"选择模板应用",clearable:"",style:{width:"200px"},onChange:oe},{default:n(()=>[(c(!0),z(E,null,K(B.value,t=>(c(),S(_,{key:t.name,label:t.name,value:t.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),l(J,{modelValue:s.pluginsJson,"onUpdate:modelValue":e[9]||(e[9]=t=>s.pluginsJson=t),type:"textarea",placeholder:"请输入JSON格式的插件配置，或点击上方按钮导入JSON文件",rows:"6"},null,8,["modelValue"])])]),_:1}),l(y,{label:"状态",prop:"status"},{default:n(()=>[l(_e,{modelValue:s.status,"onUpdate:modelValue":e[10]||(e[10]=t=>s.status=t),"active-value":1,"inactive-value":0,"active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])]),_:1}),l(y,{label:"配置信息",prop:"configJson"},{default:n(()=>[l(J,{modelValue:s.configJson,"onUpdate:modelValue":e[11]||(e[11]=t=>s.configJson=t),type:"textarea",placeholder:"请输入JSON格式的配置信息",rows:"4",maxlength:"1000"},null,8,["modelValue"])]),_:1}),l(y,{label:"知识库绑定"},{default:n(()=>[u("div",je,[u("div",Re,[l(I,{modelValue:h.value,"onUpdate:modelValue":e[12]||(e[12]=t=>h.value=t),placeholder:"选择要绑定的知识库",filterable:"",style:{width:"260px"}},{default:n(()=>[(c(!0),z(E,null,K(D.value,t=>(c(),S(_,{key:t.id,label:t.name||`知识库 #${t.id}`,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),l(o,{type:"primary",size:"small",disabled:!h.value||!v.value,onClick:se},{default:n(()=>[...e[24]||(e[24]=[g(" 绑定到当前Agent ",-1)])]),_:1},8,["disabled"]),e[25]||(e[25]=u("span",{style:{"font-size":"12px",color:"#909399"}},"需要先保存Agent，再绑定知识库",-1))]),V.value.length>0?(c(),S(j,{key:0,data:V.value,size:"small",border:"",style:{width:"100%","margin-top":"8px"}},{default:n(()=>[l(f,{prop:"id",label:"ID",width:"80"}),l(f,{prop:"name",label:"名称","min-width":"180"}),l(f,{prop:"description",label:"描述","min-width":"220","show-overflow-tooltip":""})]),_:1},8,["data"])):(c(),z("div",Ge,"当前Agent暂未绑定任何知识库"))])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])]),_:1},8,["userInfo"])}}},ot=Te(Qe,[["__scopeId","data-v-d910f63b"]]);export{ot as default};
