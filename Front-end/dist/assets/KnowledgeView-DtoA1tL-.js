import{r,h as Ie,i as P,o as f,w as t,b as s,d as l,e as m,c as A,f as u,t as v,C as Ae,D as Ce,m as ie,p as Te,F as he,j as Se,k as De,E as d,B as R}from"./index-DX3WRIvF.js";import{L as Ue}from"./Layout-Caa_pSpe.js";import{u as Pe}from"./userStore-B-BM9dwW.js";import{k as E}from"./knowledge-4HSt9JMS.js";import{_ as $e}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./agent-CJcu8WMq.js";const Be={class:"resource-view"},ze={class:"tab-header"},Ne={class:"config-preview"},Ke={key:1,class:"empty-tip"},Le={class:"tab-header"},Ee={class:"config-preview"},Fe={key:1,class:"empty-tip"},Oe={class:"tab-header"},Me={class:"dialog-footer"},Je={class:"dialog-footer"},Ge={class:"dialog-footer"},Ye={class:"search-container"},je={class:"search-header",style:{"margin-bottom":"15px","font-weight":"bold"}},Qe={class:"search-input-area",style:{"margin-bottom":"20px"}},Re={key:0,class:"search-results"},We={class:"result-title",style:{"margin-bottom":"10px","font-weight":"bold"}},qe={class:"result-score",style:{"margin-bottom":"5px"}},He={class:"result-content",style:{"white-space":"pre-wrap","line-height":"1.5"}},Xe={key:0,class:"result-meta",style:{"margin-top":"5px",color:"#999","font-size":"12px"}},Ze={key:1,class:"empty-result",style:{"text-align":"center",color:"#999",padding:"20px"}},W="api_config_templates",q="plugin_config_templates",el={__name:"KnowledgeView",setup(ll){const C=Pe(),H=r("api"),c=r([]),T=r(!1),_=r({name:"",config:""}),$=r(-1),g=r([]),h=r(!1),w=r({name:"",config:""}),B=r(-1),X=r([]),S=r(!1),F=r(!1),z=r(null),D=r(""),I=r([]),O=r(!1),M=r(!1),re=a=>{z.value=a,D.value="",I.value=[],M.value=!1,F.value=!0},Z=async()=>{if(!D.value.trim()){d.warning("请输入检索内容");return}O.value=!0,M.value=!0,I.value=[];try{const a=await E.vectorSearch(D.value,z.value.id);a.code===200?I.value=a.data:d.error(a.message||"检索失败")}catch{d.error("检索异常")}finally{O.value=!1}},ue=a=>a<.3?"success":a<.5?"warning":"danger",U=r(!1),p=r({file:null,name:"",description:"",agentId:""}),J=r([]),G=r(!1),ee=a=>{try{const e=localStorage.getItem(a);return e?JSON.parse(e):[]}catch(e){return console.error("加载模板失败:",e),[]}},N=(a,e)=>{localStorage.setItem(a,JSON.stringify(e))},le=()=>{c.value=ee(W)},te=()=>{g.value=ee(q)},ae=(a,e)=>{a?(_.value={...a},$.value=e):(_.value={name:"",config:""},$.value=-1),T.value=!0},de=()=>{var n;const a=(n=_.value.name)==null?void 0:n.trim();if(!a){d.warning("请输入模板名称");return}const e={..._.value,name:a,createdAt:_.value.createdAt||new Date().toISOString()};if($.value>=0)c.value.splice($.value,1,e);else{const i=c.value.findIndex(k=>k.name===a);i>=0?c.value.splice(i,1,e):c.value.push(e)}N(W,c.value),d.success("API 模板已保存到本地浏览器"),T.value=!1},pe=a=>{R.confirm("确定要删除该 API 模板吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{c.value.splice(a,1),N(W,c.value),d.success("已删除 API 模板")}).catch(()=>{})},oe=(a,e)=>{a?(w.value={...a},B.value=e):(w.value={name:"",config:""},B.value=-1),h.value=!0},me=()=>{var n;const a=(n=w.value.name)==null?void 0:n.trim();if(!a){d.warning("请输入模板名称");return}const e={...w.value,name:a,createdAt:w.value.createdAt||new Date().toISOString()};if(B.value>=0)g.value.splice(B.value,1,e);else{const i=g.value.findIndex(k=>k.name===a);i>=0?g.value.splice(i,1,e):g.value.push(e)}N(q,g.value),d.success("插件模板已保存到本地浏览器"),h.value=!1},fe=a=>{R.confirm("确定要删除该插件模板吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{g.value.splice(a,1),N(q,g.value),d.success("已删除插件模板")}).catch(()=>{})},Y=a=>{if(!a)return"";try{return new Date(a).toLocaleString()}catch{return a}},ne=a=>{if(!a)return"";const e=String(a).replace(/\s+/g," ");return e.length>80?`${e.slice(0,80)}...`:e},K=async()=>{S.value=!0;try{const a=await E.listKnowledgeBases();X.value=Array.isArray(a)?a:a.data||[]}catch(a){console.error("加载知识库列表失败:",a),d.error("加载知识库列表失败")}finally{S.value=!1}},ve=a=>{R.confirm(`确定删除知识库"${a.name}"？该操作会移除所有已向量化的内容且不可恢复。`,"提示",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"}).then(async()=>{S.value=!0;try{const e=await E.deleteKnowledgeBase(a.id);e.code===200?(d.success("删除成功"),K()):d.error(e.message||"删除失败")}catch(e){console.error("删除知识库失败:",e),d.error("删除失败，请稍后重试")}finally{S.value=!1}}).catch(()=>{})},ce=()=>{p.value={file:null,name:"",description:"",agentId:""},J.value=[],U.value=!0},ge=(a,e)=>{p.value.file=a.raw,J.value=e.slice(-1),p.value.name||(p.value.name=a.name)},_e=async()=>{if(!p.value.file){d.warning("请先选择要上传的文件");return}G.value=!0;try{const{file:a,name:e,description:n,agentId:i}=p.value;await E.uploadKnowledge({file:a,name:e,description:n,agentId:i?Number(i):void 0}),d.success("上传成功，系统会自动进行拆分和向量化"),U.value=!1,K()}catch(a){console.error("上传知识库失败:",a),d.error("上传失败，请检查文件格式或稍后重试")}finally{G.value=!1}},we=()=>{K()};return Ie(async()=>{if(C&&!C.initialized&&C.initializeUserInfo)try{await C.initializeUserInfo()}catch(a){console.error("初始化用户信息失败:",a)}le(),te(),K()}),(a,e)=>{const n=m("el-button"),i=m("el-table-column"),k=m("el-table"),j=m("el-tab-pane"),ye=m("el-tabs"),se=m("el-card"),y=m("el-input"),b=m("el-form-item"),Q=m("el-form"),L=m("el-dialog"),be=m("el-upload"),Ve=m("el-tag"),ke=Ce("loading");return f(),P(Ue,{userInfo:De(C).userInfo},{default:t(()=>[s("div",Be,[l(se,{class:"box-card"},{header:t(()=>[...e[18]||(e[18]=[s("div",{class:"card-header"},[s("span",null,"资源库")],-1)])]),default:t(()=>[l(ye,{modelValue:H.value,"onUpdate:modelValue":e[2]||(e[2]=o=>H.value=o)},{default:t(()=>[l(j,{label:"API 模板",name:"api"},{default:t(()=>[s("div",ze,[l(n,{type:"primary",onClick:e[0]||(e[0]=o=>ae())},{default:t(()=>[...e[19]||(e[19]=[u("新建模板",-1)])]),_:1}),l(n,{onClick:le},{default:t(()=>[...e[20]||(e[20]=[u("刷新",-1)])]),_:1})]),c.value.length>0?(f(),P(k,{key:0,data:c.value,size:"small",style:{width:"100%"}},{default:t(()=>[l(i,{prop:"name",label:"名称",width:"180"}),l(i,{label:"内容预览","min-width":"260"},{default:t(o=>[s("span",Ne,v(ne(o.row.config)),1)]),_:1}),l(i,{prop:"createdAt",label:"创建时间",width:"180"},{default:t(o=>[s("span",null,v(Y(o.row.createdAt)),1)]),_:1}),l(i,{label:"操作",width:"160"},{default:t(o=>[l(n,{type:"primary",link:"",size:"small",onClick:V=>ae(o.row,o.$index)},{default:t(()=>[...e[21]||(e[21]=[u(" 编辑 ",-1)])]),_:1},8,["onClick"]),l(n,{type:"danger",link:"",size:"small",onClick:V=>pe(o.$index)},{default:t(()=>[...e[22]||(e[22]=[u(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])):(f(),A("div",Ke," 暂无 API 模板，可以在「Agent配置」中保存，或点击上方「新建模板」。 "))]),_:1}),l(j,{label:"插件模板",name:"plugin"},{default:t(()=>[s("div",Le,[l(n,{type:"primary",onClick:e[1]||(e[1]=o=>oe())},{default:t(()=>[...e[23]||(e[23]=[u("新建模板",-1)])]),_:1}),l(n,{onClick:te},{default:t(()=>[...e[24]||(e[24]=[u("刷新",-1)])]),_:1})]),g.value.length>0?(f(),P(k,{key:0,data:g.value,size:"small",style:{width:"100%"}},{default:t(()=>[l(i,{prop:"name",label:"名称",width:"180"}),l(i,{label:"内容预览","min-width":"260"},{default:t(o=>[s("span",Ee,v(ne(o.row.config)),1)]),_:1}),l(i,{prop:"createdAt",label:"创建时间",width:"180"},{default:t(o=>[s("span",null,v(Y(o.row.createdAt)),1)]),_:1}),l(i,{label:"操作",width:"160"},{default:t(o=>[l(n,{type:"primary",link:"",size:"small",onClick:V=>oe(o.row,o.$index)},{default:t(()=>[...e[25]||(e[25]=[u(" 编辑 ",-1)])]),_:1},8,["onClick"]),l(n,{type:"danger",link:"",size:"small",onClick:V=>fe(o.$index)},{default:t(()=>[...e[26]||(e[26]=[u(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])):(f(),A("div",Fe," 暂无插件模板，可以在「Agent配置」中保存，或点击上方「新建模板」。 "))]),_:1}),l(j,{label:"知识库",name:"knowledge"},{default:t(()=>[s("div",Oe,[l(n,{type:"primary",onClick:ce},{default:t(()=>[...e[27]||(e[27]=[u("上传知识文件",-1)])]),_:1}),l(n,{onClick:we},{default:t(()=>[...e[28]||(e[28]=[u("刷新",-1)])]),_:1})]),Ae((f(),P(k,{data:X.value,style:{width:"100%"}},{default:t(()=>[l(i,{prop:"id",label:"ID",width:"80"}),l(i,{prop:"name",label:"名称","min-width":"180"}),l(i,{prop:"description",label:"描述","min-width":"220","show-overflow-tooltip":""}),l(i,{prop:"createdAt",label:"创建时间",width:"180"},{default:t(o=>[s("span",null,v(Y(o.row.createdAt)),1)]),_:1}),l(i,{label:"操作",width:"180"},{default:t(o=>[l(n,{type:"primary",link:"",size:"small",onClick:V=>re(o.row)},{default:t(()=>[...e[29]||(e[29]=[u(" 向量检索 ",-1)])]),_:1},8,["onClick"]),l(n,{type:"danger",link:"",size:"small",onClick:V=>ve(o.row)},{default:t(()=>[...e[30]||(e[30]=[u(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ke,S.value]])]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(L,{modelValue:T.value,"onUpdate:modelValue":e[6]||(e[6]=o=>T.value=o),title:"编辑 API 模板",width:"600px"},{footer:t(()=>[s("span",Me,[l(n,{onClick:e[5]||(e[5]=o=>T.value=!1)},{default:t(()=>[...e[31]||(e[31]=[u("取 消",-1)])]),_:1}),l(n,{type:"primary",onClick:de},{default:t(()=>[...e[32]||(e[32]=[u("保 存",-1)])]),_:1})])]),default:t(()=>[l(Q,{"label-width":"80px"},{default:t(()=>[l(b,{label:"名称"},{default:t(()=>[l(y,{modelValue:_.value.name,"onUpdate:modelValue":e[3]||(e[3]=o=>_.value.name=o),placeholder:"请输入模板名称"},null,8,["modelValue"])]),_:1}),l(b,{label:"内容"},{default:t(()=>[l(y,{modelValue:_.value.config,"onUpdate:modelValue":e[4]||(e[4]=o=>_.value.config=o),type:"textarea",rows:8,placeholder:"请输入 API 配置内容，可为纯文本或 JSON"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(L,{modelValue:h.value,"onUpdate:modelValue":e[10]||(e[10]=o=>h.value=o),title:"编辑插件模板",width:"600px"},{footer:t(()=>[s("span",Je,[l(n,{onClick:e[9]||(e[9]=o=>h.value=!1)},{default:t(()=>[...e[33]||(e[33]=[u("取 消",-1)])]),_:1}),l(n,{type:"primary",onClick:me},{default:t(()=>[...e[34]||(e[34]=[u("保 存",-1)])]),_:1})])]),default:t(()=>[l(Q,{"label-width":"80px"},{default:t(()=>[l(b,{label:"名称"},{default:t(()=>[l(y,{modelValue:w.value.name,"onUpdate:modelValue":e[7]||(e[7]=o=>w.value.name=o),placeholder:"请输入模板名称"},null,8,["modelValue"])]),_:1}),l(b,{label:"内容"},{default:t(()=>[l(y,{modelValue:w.value.config,"onUpdate:modelValue":e[8]||(e[8]=o=>w.value.config=o),type:"textarea",rows:8,placeholder:"请输入插件配置内容，建议为 JSON 格式"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(L,{modelValue:U.value,"onUpdate:modelValue":e[15]||(e[15]=o=>U.value=o),title:"上传知识文件",width:"500px"},{footer:t(()=>[s("span",Ge,[l(n,{onClick:e[14]||(e[14]=o=>U.value=!1)},{default:t(()=>[...e[38]||(e[38]=[u("取 消",-1)])]),_:1}),l(n,{type:"primary",loading:G.value,onClick:_e},{default:t(()=>[...e[39]||(e[39]=[u("上 传",-1)])]),_:1},8,["loading"])])]),default:t(()=>[l(Q,{model:p.value,"label-width":"80px"},{default:t(()=>[l(b,{label:"文件"},{default:t(()=>[l(be,{class:"upload-demo",drag:"","auto-upload":!1,limit:1,"file-list":J.value,"on-change":ge},{tip:t(()=>[...e[35]||(e[35]=[s("div",{class:"el-upload__tip"}," 支持 PDF / Word / Markdown 等常见格式，单个文件不要太大。 ",-1)])]),default:t(()=>[e[36]||(e[36]=s("i",{class:"el-icon-upload"},null,-1)),e[37]||(e[37]=s("div",{class:"el-upload__text"},[u(" 将文件拖到此处，或"),s("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1}),l(b,{label:"名称"},{default:t(()=>[l(y,{modelValue:p.value.name,"onUpdate:modelValue":e[11]||(e[11]=o=>p.value.name=o),placeholder:"可选，不填则使用文件名"},null,8,["modelValue"])]),_:1}),l(b,{label:"描述"},{default:t(()=>[l(y,{modelValue:p.value.description,"onUpdate:modelValue":e[12]||(e[12]=o=>p.value.description=o),type:"textarea",rows:3,placeholder:"可选，对知识库做一个简单说明"},null,8,["modelValue"])]),_:1}),l(b,{label:"绑定Agent"},{default:t(()=>[l(y,{modelValue:p.value.agentId,"onUpdate:modelValue":e[13]||(e[13]=o=>p.value.agentId=o),placeholder:"可选，填写要绑定的 Agent ID（暂时先用数字ID）"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(L,{modelValue:F.value,"onUpdate:modelValue":e[17]||(e[17]=o=>F.value=o),title:"向量检索测试",width:"700px"},{default:t(()=>{var o,V;return[s("div",Ye,[s("div",je,[s("span",null,"当前知识库："+v((o=z.value)==null?void 0:o.name)+" (ID: "+v((V=z.value)==null?void 0:V.id)+")",1)]),s("div",Qe,[l(y,{modelValue:D.value,"onUpdate:modelValue":e[16]||(e[16]=x=>D.value=x),placeholder:"请输入要检索的文本...",onKeyup:Te(Z,["enter"]),clearable:""},{append:t(()=>[l(n,{onClick:Z,loading:O.value},{default:t(()=>[...e[40]||(e[40]=[u("检索",-1)])]),_:1},8,["loading"])]),_:1},8,["modelValue"])]),I.value.length>0?(f(),A("div",Re,[s("div",We,"检索结果 (Top "+v(I.value.length)+")：",1),(f(!0),A(he,null,Se(I.value,(x,xe)=>(f(),P(se,{key:xe,class:"result-item",shadow:"hover",style:{"margin-bottom":"10px"}},{default:t(()=>[s("div",qe,[l(Ve,{size:"small",type:ue(x.score)},{default:t(()=>[u("距离: "+v(x.score.toFixed(4)),1)]),_:2},1032,["type"])]),s("div",He,v(x.content),1),x.metadata?(f(),A("div",Xe,"元数据: "+v(x.metadata),1)):ie("",!0)]),_:2},1024))),128))])):M.value?(f(),A("div",Ze," 未找到相关结果 ")):ie("",!0)])]}),_:1},8,["modelValue"])])]),_:1},8,["userInfo"])}}},rl=$e(el,[["__scopeId","data-v-76b1ac0a"]]);export{rl as default};
