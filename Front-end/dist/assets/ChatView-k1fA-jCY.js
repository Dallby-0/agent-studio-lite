import{g as H,r as f,h as J,i as R,o as u,w as k,b as t,c as d,m as x,j as E,F as b,d as _,t as c,f as $,e as I,k as T,n as D,p as G,q as X,E as j,s as F,v as K}from"./index-g6aQcVIG.js";import{L as Q}from"./Layout-kDhWiEU5.js";import{u as W}from"./userStore-DdKhfmJw.js";import{a as Y}from"./agent-CEcTJNdc.js";import{_ as Z}from"./_plugin-vue_export-helper-DlAUqK2U.js";const C=H.create({timeout:6e4,headers:{"Content-Type":"application/json"}});C.interceptors.request.use(o=>{const l=localStorage.getItem("token");return l&&(o.headers.Authorization=`Bearer ${l}`),o},o=>(console.error("请求错误:",o),Promise.reject(o)));C.interceptors.response.use(o=>o.data,o=>(console.error("响应错误:",o),Promise.reject(o)));const ee={async sendMessage(o,l,g=null){try{const a=g?{messages:g}:{message:l},n=await C.post(`/api/agent-chat/${o}`,a);return console.log("Agent聊天响应:",n),n}catch(a){throw console.error("Agent聊天失败:",a),a}},async getAgentInfo(o){try{return await C.get(`/api/agent-chat/${o}/info`)}catch(l){throw console.error("获取Agent信息失败:",l),l}}},te={class:"chat-page"},se={class:"agent-sidebar"},ae={class:"agent-list"},oe=["onClick"],ne={class:"agent-avatar"},re={class:"agent-info"},le={class:"agent-name"},ie={class:"agent-type"},ce={key:0,class:"no-agents"},ue={class:"chat-main"},de={class:"chat-header"},ve={class:"current-agent"},me={class:"agent-avatar"},_e={class:"agent-name"},ge={class:"agent-desc"},pe={key:0,class:"empty-chat"},he={class:"message-avatar"},fe={class:"message-content"},ye={class:"message-text"},ke={class:"message-time"},we={key:1,class:"message assistant"},Ae={class:"message-avatar"},Ce={class:"input-area"},Se={key:1,class:"no-agent-selected"},Me="agent_chat_history_",xe={__name:"ChatView",setup(o){const l=W(),g=f([]),a=f(null),n=f([]),p=f(""),h=f(!1),m=f(null),S=s=>s?`${Me}${s}`:null,L=s=>{const e=S(s);if(e)try{const i=localStorage.getItem(e);if(i){const v=JSON.parse(i);if(Array.isArray(v)){n.value=v,K(()=>{m.value&&(m.value.scrollTop=m.value.scrollHeight)});return}}n.value=[]}catch(i){console.error("加载聊天历史失败:",i),n.value=[]}},M=()=>{if(!a.value)return;const s=S(a.value.id);if(s)try{localStorage.setItem(s,JSON.stringify(n.value))}catch(e){console.error("保存聊天历史失败:",e)}},O=async()=>{try{const s=await Y.getAgents();g.value=s.data||s||[]}catch(s){console.error("获取智能体列表失败:",s),j.error("获取智能体列表失败")}},P=s=>{var e;((e=a.value)==null?void 0:e.id)!==s.id&&(a.value=s,L(s.id),console.log("选择智能体:",s.name))},V=async()=>{var e;if(!p.value.trim()||h.value||!a.value)return;const s=p.value.trim();p.value="",n.value.push({role:"user",content:s,timestamp:new Date}),M(),z(),h.value=!0;try{const i=n.value.map(w=>({role:w.role,content:w.content})),v=await ee.sendMessage(a.value.id,null,i);(e=v.data)!=null&&e.response&&(n.value.push({role:"assistant",content:v.data.response,timestamp:new Date}),M())}catch(i){console.error("发送消息失败:",i),j.error("发送消息失败，请稍后重试"),n.value.push({role:"assistant",content:"抱歉，发生了错误，请稍后重试。",timestamp:new Date}),M()}finally{h.value=!1,z()}},U=()=>{if(n.value=[],a.value){const s=S(a.value.id);if(s)try{localStorage.removeItem(s)}catch(e){console.error("清理聊天历史失败:",e)}}},z=()=>{K(()=>{m.value&&(m.value.scrollTop=m.value.scrollHeight)})},q=s=>s?new Date(s).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):"";return J(async()=>{l.initialized||await l.initializeUserInfo(),await O()}),(s,e)=>{const i=I("el-button"),v=I("el-icon"),w=I("el-input");return u(),R(Q,{userInfo:T(l).userInfo},{default:k(()=>{var N,B;return[t("div",te,[t("div",se,[e[1]||(e[1]=t("div",{class:"sidebar-header"},[t("h3",null,"选择智能体")],-1)),t("div",ae,[(u(!0),d(b,null,E(g.value,r=>{var A,y;return u(),d("div",{key:r.id,class:F(["agent-item",{active:((A=a.value)==null?void 0:A.id)===r.id}]),onClick:be=>P(r)},[t("div",ne,c(((y=r.name)==null?void 0:y.charAt(0))||"A"),1),t("div",re,[t("div",le,c(r.name),1),t("div",ie,c(r.type||"通用"),1)])],10,oe)}),128)),g.value.length===0?(u(),d("div",ce," 暂无可用的智能体 ")):x("",!0)])]),t("div",ue,[a.value?(u(),d(b,{key:0},[t("div",de,[t("div",ve,[t("div",me,c(((N=a.value.name)==null?void 0:N.charAt(0))||"A"),1),t("div",null,[t("div",_e,c(a.value.name),1),t("div",ge,c(a.value.description||"智能助手"),1)])]),_(i,{size:"small",onClick:U},{default:k(()=>[...e[2]||(e[2]=[$("清空对话",-1)])]),_:1})]),t("div",{class:"messages-container",ref_key:"messagesContainer",ref:m},[n.value.length===0?(u(),d("div",pe,[_(v,{size:"48"},{default:k(()=>[_(T(D))]),_:1}),t("p",null,"开始与 "+c(a.value.name)+" 对话吧！",1)])):x("",!0),(u(!0),d(b,null,E(n.value,(r,A)=>{var y;return u(),d("div",{key:A,class:F(["message",r.role])},[t("div",he,c(r.role==="user"?"我":(y=a.value.name)==null?void 0:y.charAt(0)),1),t("div",fe,[t("div",ye,c(r.content),1),t("div",ke,c(q(r.timestamp)),1)])],2)}),128)),h.value?(u(),d("div",we,[t("div",Ae,c((B=a.value.name)==null?void 0:B.charAt(0)),1),e[3]||(e[3]=t("div",{class:"message-content"},[t("div",{class:"message-text typing"},"正在思考中...")],-1))])):x("",!0)],512),t("div",Ce,[_(w,{modelValue:p.value,"onUpdate:modelValue":e[0]||(e[0]=r=>p.value=r),type:"textarea",rows:2,placeholder:"输入消息，按Enter发送...",onKeydown:G(X(V,["exact","prevent"]),["enter"]),disabled:h.value},null,8,["modelValue","onKeydown","disabled"]),_(i,{type:"primary",onClick:V,loading:h.value,disabled:!p.value.trim()},{default:k(()=>[...e[4]||(e[4]=[$(" 发送 ",-1)])]),_:1},8,["loading","disabled"])])],64)):(u(),d("div",Se,[_(v,{size:"64"},{default:k(()=>[_(T(D))]),_:1}),e[5]||(e[5]=t("h2",null,"请选择一个智能体开始对话",-1)),e[6]||(e[6]=t("p",null,"从左侧列表选择一个智能体，即可开始聊天",-1))]))])])]}),_:1},8,["userInfo"])}}},Be=Z(xe,[["__scopeId","data-v-6ea6fb2d"]]);export{Be as default};
