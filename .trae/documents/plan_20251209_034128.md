# 工作流引擎实现计划

## 1. 数据库设计

### 1.1 工作流表 (workflow)

* 存储工作流的基本信息

* 字段：id, name, description, version, status, created\_by, created\_at, updated\_at, is\_deleted

### 1.2 工作流节点表 (workflow\_node)

* 存储工作流中的节点信息

* 字段：id, workflow\_id, name, type, config\_json, position\_x, position\_y, created\_at, updated\_at

* 节点类型：start（开始）, end（结束）, llm\_call（大模型调用）, condition（条件判断）, variable（变量赋值）

### 1.3 工作流边表 (workflow\_edge)

* 存储节点之间的连接关系

* 字段：id, workflow\_id, from\_node\_id, to\_node\_id, condition, created\_at, updated\_at

### 1.4 工作流实例表 (workflow\_instance)

* 存储工作流的运行实例

* 字段：id, workflow\_id, name, status, input\_params, output\_params, started\_at, finished\_at, created\_at, updated\_at

### 1.5 工作流执行日志表 (workflow\_execution\_log)

* 存储工作流的执行过程日志

* 字段：id, instance\_id, node\_id, node\_type, execution\_time, status, input\_data, output\_data, created\_at

## 2. 后端实现

### 2.1 实体类设计

* Workflow：工作流实体

* WorkflowNode：工作流节点实体

* WorkflowEdge：工作流边实体

* WorkflowInstance：工作流实例实体

* WorkflowExecutionLog：工作流执行日志实体

### 2.2 Mapper接口

* WorkflowMapper：工作流数据访问接口

* WorkflowNodeMapper：工作流节点数据访问接口

* WorkflowEdgeMapper：工作流边数据访问接口

* WorkflowInstanceMapper：工作流实例数据访问接口

* WorkflowExecutionLogMapper：工作流执行日志数据访问接口

### 2.3 服务层设计

* WorkflowService：工作流定义管理服务

* WorkflowInstanceService：工作流实例管理服务

* WorkflowEngine：工作流执行引擎核心

* NodeProcessor：节点处理器接口，实现不同类型节点的处理逻辑

  * StartNodeProcessor：开始节点处理器

  * EndNodeProcessor：结束节点处理器

  * LLMCallNodeProcessor：大模型调用节点处理器

  * ConditionNodeProcessor：条件判断节点处理器

  * VariableNodeProcessor：变量赋值节点处理器

### 2.4 控制器设计

* WorkflowController：工作流定义管理接口

* WorkflowInstanceController：工作流实例管理接口

* WorkflowEngineController：工作流执行引擎接口

## 3. 前端实现

### 3.1 工作流设计器组件

* WorkflowDesigner：主设计器组件，包含画布和工具栏

* NodePalette：节点面板，展示可拖拽的节点类型

* NodeConfigPanel：节点配置面板，用于配置节点属性

* Canvas：工作流画布，支持拖拽、连接、缩放等操作

### 3.2 工作流管理界面

* WorkflowList：工作流列表页面

* WorkflowDetail：工作流详情页面

* WorkflowInstanceList：工作流实例列表页面

* WorkflowInstanceDetail：工作流实例详情页面

### 3.3 路由配置

* 添加工作流相关路由：/workflows, /workflows/designer, /workflows/instances

## 4. 集成AI服务

* 在LLMCallNodeProcessor中调用现有的AIService

* 支持将工作流输入参数作为大模型的用户prompt

* 支持配置系统prompt和插件

## 5. 实现步骤

1. 创建数据库表结构
2. 实现后端实体类、Mapper、Service和Controller
3. 实现前端工作流设计器组件
4. 实现工作流管理界面
5. 集成AI服务
6. 测试工作流引擎的基本功能

## 6. 节点类型说明

### 6.1 开始节点 (start)

* 工作流的入口节点

* 支持配置工作流的输入参数

### 6.2 结束节点 (end)

* 工作流的出口节点

* 支持配置工作流的输出参数

### 6.3 大模型调用节点 (llm\_call)

* 调用大语言模型API

* 支持配置系统prompt、用户prompt模板、模型参数

* 支持将工作流变量作为prompt的一部分

### 6.4 条件判断节点 (condition)

* 根据条件判断工作流的走向

* 支持配置条件表达式

* 支持多分支输出

### 6.5 变量赋值节点 (variable)

* 用于设置或修改工作流变量

* 支持配置变量名和表达式

