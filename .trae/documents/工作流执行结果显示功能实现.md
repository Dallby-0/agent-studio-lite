# 工作流执行结果显示功能实现

## 1. 需求分析
当前工作流执行后只返回成功消息，用户无法直观查看执行结果和过程。需要实现一个等待窗口，实时显示执行状态和结果。

## 2. 技术方案

### 2.1 后端接口设计

#### 2.1.1 现有接口
- `POST /api/workflow-instances/start/{workflowId}`：启动工作流实例
- `GET /api/workflow-instances/{id}`：获取工作流实例详情
- `GET /api/workflow-instances/{id}/logs`：获取工作流实例执行日志

#### 2.1.2 新增接口
- **GET /api/workflow-instances/{id}/status**：获取工作流实例状态（优化轮询性能）
  - 返回：实例状态、当前执行节点、已执行时间

### 2.2 前端实现

#### 2.2.1 新增组件
- **执行结果对话框**：显示工作流执行状态、进度和结果
  - 加载动画：显示执行中的状态
  - 执行日志：实时显示节点执行过程
  - 结果展示：显示最终执行结果
  - 操作按钮：关闭窗口、查看详情

#### 2.2.2 轮询机制
- 启动工作流后打开执行结果对话框
- 每2秒调用一次状态接口，检查执行状态
- 执行完成后显示最终结果
- 支持手动刷新和取消轮询

## 3. 实现步骤

### 3.1 前端实现

#### 3.1.1 修改 workflow.js
- 新增 `getWorkflowInstanceStatus` 方法
- 新增 `getWorkflowInstanceResult` 方法

#### 3.1.2 修改 WorkflowDesignerView.vue
- 新增执行结果对话框组件
- 修改 `executeWorkflow` 方法，启动工作流后打开对话框
- 实现轮询逻辑，检查工作流状态
- 显示执行日志和结果

### 3.2 后端实现

#### 3.2.1 修改 WorkflowInstanceController
- 新增 `getStatus` 方法，返回实例状态和当前执行节点
- 优化 `getExecutionLogs` 方法，支持按时间排序

#### 3.2.2 修改 WorkflowInstanceServiceImpl
- 新增 `getStatus` 方法实现

## 4. 数据结构

### 4.1 状态接口返回结构
```json
{
  "id": 1,
  "status": "running",
  "currentNode": {
    "id": 2,
    "name": "大模型调用",
    "type": "llm_call"
  },
  "startedAt": "2025-12-10T20:46:04.228",
  "executionTime": 15.5
}
```

### 4.2 结果接口返回结构
```json
{
  "instance": {
    "id": 1,
    "status": "completed",
    "inputParams": {"question": "你好"},
    "outputParams": {"answer": "你好！我是AI助手"},
    "executionTime": 20.3
  },
  "logs": [
    {
      "nodeName": "开始节点",
      "nodeType": "start",
      "status": "success",
      "executionTime": 0.1,
      "timestamp": "2025-12-10T20:46:04.300"
    },
    {
      "nodeName": "大模型调用",
      "nodeType": "llm_call",
      "status": "success",
      "executionTime": 18.5,
      "timestamp": "2025-12-10T20:46:22.800"
    },
    {
      "nodeName": "结束节点",
      "nodeType": "end",
      "status": "success",
      "executionTime": 0.1,
      "timestamp": "2025-12-10T20:46:22.900"
    }
  ]
}
```

## 5. 界面设计

### 5.1 执行中状态
- 显示加载动画
- 实时显示当前执行节点
- 显示已执行时间
- 显示已执行的节点日志

### 5.2 执行完成状态
- 显示执行结果（成功/失败）
- 显示完整执行日志
- 显示最终输出参数
- 提供查看详情和关闭按钮

## 6. 交互流程

1. 用户点击"运行工作流"按钮
2. 打开运行参数对话框，用户输入参数
3. 点击"确定运行"，关闭参数对话框
4. 打开执行结果对话框，显示加载状态
5. 轮询调用状态接口
6. 实时更新执行状态和日志
7. 执行完成后显示最终结果
8. 用户可选择关闭对话框或查看详情

## 7. 优化点

1. **性能优化**：使用WebSocket替代轮询，减少服务器压力
2. **用户体验**：添加取消执行功能
3. **日志优化**：支持日志过滤和搜索
4. **结果可视化**：将执行结果以图表形式展示

## 8. 兼容性考虑

- 保持与现有代码风格一致
- 兼容现有工作流执行逻辑
- 支持不同浏览器环境
- 适配响应式设计

## 9. 测试计划

1. 测试工作流正常执行流程
2. 测试工作流执行失败场景
3. 测试长时间执行的工作流
4. 测试轮询机制的稳定性
5. 测试界面的兼容性和响应性

## 10. 风险评估

1. **性能风险**：频繁轮询可能增加服务器压力
2. **用户体验风险**：长时间执行可能导致用户等待不耐烦
3. **兼容性风险**：不同浏览器对WebSocket的支持差异

## 11. 后续扩展

1. 支持工作流执行的实时监控
2. 支持工作流执行的可视化展示
3. 支持工作流执行的回放功能
4. 支持工作流执行的告警通知